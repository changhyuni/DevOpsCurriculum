# Quest 06. 컨테이너

## Introduction
* 이번 퀘스트에서는 컨테이너 기술과 그 활용에 대해 알아보겠습니다.

## Topics
* 컨테이너 기술
* Docker
* docker-compose

## Resources
* https://www.docker.com/101-tutorial
* https://docker-curriculum.com/
* https://docs.docker.com/compose/

## Checklist
* 컨테이너는 어떻게 동작하나요? 다른 배포판을 사용할 수 있게 하는 원리가 무엇일까요?

컨테이너는 리눅스의 커널 기반 기술인 `Cgroup`과 `namespace,chroot`를 사용하여 프로세스를 완벽하게 격리해 분리된 환경을 만들고 동작합니다. `Cgroup`은 시스템의 CPU시간,시스템 메모리,네트워크 대역폭과 같은 자원을 제한하고 격리할 수 있는 커널 기능입니다.
`namespace`는 시스템 리소스를 프로세스의 전용 자원처럼 보이게하고, 다른 프로세스와 격리시키는 기능입니다. 기능은 총 6가지(`mount, pid, network, ipc, uts, use`)를 이용하여 프로세스를 격리시킬 수 있습니다. 컨테이너가 각 배포판을 사용할 수 있는 이유는 컨테이너 이미지에 있습니다. 컨테이너 이미지는 유니온 마운트기술을 사용하며 컨테이너를 실행시키는 각 레이어별로 구성되고, 이 레이어들은 bootfs를 시작으로 사용자가 원하는 패키지나 어플리케이션 레이어를 하나씩 쌓아가게됩니다. 이렇게 쌓여진 레이어는 `read-only`상태로 수정할 수 없고 컨테이너를 실행할 때 가장 맨위에 아무것도 없는 레이어를 만들고 해당 레이어에서 쌓여진 모든 레이어들을 마운트하면서 컨테이너가 실행됩니다. 이때, 가장 맨 위에 있는 레이어는 `read-only`가 아닌 `read-write`로 올려져 사용자가 수정하고 사용할 수 있게 합니다. 컨테이너를 종료할 때는 맨위에 있는 `read-write`인 레이어를 삭제하게됩니다. 이러한 이유는 도커 네트워크 구조때문인데 각 컨테이너마다 별도의 네트워크 인터페이스를 가지고 -p 명령을 사용하거나 expose하게되면 veth라는 가상의 네트워크 인터페이스가 도커 컨테이너 외부에 생기는데 해당 인터페이스를 사용해서 호스트에 네트워크 인터페이스랑 통신할 수 있는 `docker0`라는 네트워크 인터페이스와 연결할 수 있습니다.   

* 도커 컨테이너에 호스트의 파일시스템이나 네트워크 포트를 연결하려면 어떻게 해야 할까요?

`docker run -p 8080:80 httpd`  
`Dockerfile`이나 `docker -p (expose)`를 통해 포트를 연결할 수 있습니다. 도커 컨테이너를 생성하면 기본적으로 외부와 통신이 불가능한 상태입니다. 따라서, 외부통신을 하기 위해서는 컨테이너 외부로 노출할 Port를 노출시켜야 합니다. 예시를 보게되면 `docker host`의 8080포트로 요청이 들어오면 80포트로 해당 요청을 `forwarding `하겠다는 의미입니다. 

* 도커 컨테이너에서 런타임에 환경변수를 주입하려면 어떻게 해야 할까요?

`docker run --name mysqldb \      
           -e MYSQL_ROOT_PASSWORD=rootpw \      
           -p 33060:3306 -d mysql:5.7`    

Dockerfile에서 ENV를 사용하게 되면, RUN,CMD명령에서 초기 환경변수를 설정할 수 있고, 예시를 보면 컨테이너를 실행할 때 -e 옵션으로 mysql 패스워드 등을 변수로 사용할 수 있습니다.  

* 도커 컨테이너의 stdout 로그를 보려면 어떻게 해야 할까요?

도커 컨테이너에서 발생하는 로그(stdin, stdout, stderr) 표준 입력들을 json file로 저장할 수 있으며, 다른 서버에 로그 파일을 저장할 수도 있습니다. 도커에서는 로깅 드라이버를 사용하여, 여러가지 형태의 로그를 컨트롤 할 수 있습니다. 기본적인 json-file과 journald등을 사용하면 docker log 명령을 통해 실시간으로 기본적인 로그를을 확인할 수 있습니다.  별도의 로깅 드라이버를 지정하지 않는다면 json-file 로깅 드라이버를 사용합니다. 로그를 json파일 형식으로 저장합니다. 컨테이너 내부 출력이 많다면 json 파일의 크기가 계속해서 커지고, 별도 설정을 하지 않았다면 호스트의 남은 저장공간을 계속해서 사용하게 되니 주의하여야 합니다. --log-opt 옵션으로 로그파일의 최대 크기와 개수를 지정할 수 있습니다. 로그가 저장되는 위치는 기본적으로 /var/lib/docker/containers/[container-id]/[container-id]-json.log 입니다. 

* 실행중인 도커 컨테이너에 들어가 bash 등의 쉘을 실행하고 로그 등을 보려면 어떻게 해야 할까요?

## Quest
* 도커를 설치하고 그 사용법을 익혀 보세요.
* Quest 05에서 작업한 서버를 컨테이너 기반으로 띄울 수 있게 수정해 보세요. (docker-compose는 사용하지 않습니다)
* 컨테이너를 Docker Hub에 올리고, EC2에서 해당 컨테이너를 띄워서 서비스 해 보세요.
* docker-compose를 사용하여, 빌드와 서버 업/다운을 쉽게 할 수 있도록 고쳐 보세요.
