# Quest 11. 보안의 기초

## Introduction
* 이번 퀘스트에서는 네트워크와 보안에 관한 아주 기초적인 것을 다룹니다.

## Topics
* VPC, 서브넷, 방화벽
* IAM
* Secrets Manager

## Resources
* https://www.44bits.io/ko/post/understanding_aws_vpc
* https://docs.aws.amazon.com/ko_kr/IAM/latest/UserGuide/introduction.html
* https://aws.amazon.com/ko/secrets-manager/
* https://blog.logrocket.com/web-security-101/

## Checklist
* AWS의 VPC는 어떤 서비스일까요?
AWS에서 제공하는 네트워크 서비스입니다. `VPC`는 논리적으로 격리되어 있으며, 하나의 IDC라고 생각하면 쉽게 이해할 수 있습니다. 서브넷, 라우팅 테이블 및 네트워크 게이트웨이 구성등 가상 네트워킹 환경을 완벽하게 제어할 수 있습니다.  

* 인프라의 네트워크를 가상으로 구축하는 것은 어떤 장점이 있을까요?
가장 중요한 키워드는 생산성입니다. 네트워크 가상화를 통해서 하드웨어 구매 및 유지관리 비용을 줄이고 인프라 수요를 따라잡기 위해 과도하게 프로비저닝된 리소스를 효율적으로 사용할 수있습니다. 또한, 네트워크를 프로비저닝함에 있어 기존 하드웨어 방식보다 빠르게 구축할 수 있고, 가시성 또한 좋습니다.  

* IAM은 어떤 서비스일까요? 어떤 식으로 계정에 권한을 부여할까요?
AWS에서 제공하는 권한관리의 개념인 `RBAC+ABAC`를 융합한 권한관리 서비스입니다. 서비스를 이용하는 사용자들에게 권한을 직접적으로 주거나 사용자들을 그룹으로 묶어 권한을 부여하는 형식이 아닌, 권한의 논리적 집합으로 '역할' 이라는 것을 만들고 역할을 사용자 그룹이나 사용자 에게 연결합니다. 즉 Group (사용자그룹)으로 주로 사용하면서, Role(역할)은 권한의 Group으로 사용하는 것입니다.  
<IAM 개념파악>  
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::knowre/*"
    }
  ]
}  
`effect` (allow/deny), `action`(aws 서비스에 사용되는 작업 리소스 및 조건키), `resource`(statement가 주체가 되는 리소스를 한정합니다), `Principal`(리소스 기반 정책에서, 보안 주체를 지정), `sid`(고유 식별자)  
Policy(정책)은 앞에 달리는 수식어가 다양합니다. 연결 대상이 어디인가에 따라 자격증명- 기반 정책, 리소스-기반 정책, 신뢰 정책 별로 나뉘고 고객관리 정책, AWS 관리 정책 등이 있습니다. 하지만, 여기서 가장 중요한건 자격증명-기반 정책과, 리소스-기반 정책입니다.
자격증명-기반 정책을 사용할 때에는 그 정책에 연결된 보안 주체(aws,iam)등 역할 혹은 연합의 인증된 사용자(cognito) 가 암묵적인 principal이 됩니다. 그래서, 자격증명-기반 정책은 따로 principal이 없습니다. 반대로, 리소스-기반 정책은 aws서비스중 일부에서 사용됩니다 (대표적으로 s3) 여기서는 `principal`를 통해서 해당 서비스의 리소스에서 자체적으로 관리할 수 있고, 반대로 자격증명-기반 정책은 aws iam에서 직접관리 합니다.   

* DB 패스워드와 같이 민감한 정보를 어떤 식으로 관리하는 것이 좋을까요?
호스트나 운영하는 서비스에 직접적으로 변수로 지정하거나 하드코딩하는 방식은 보안에 매우 취약하다고 생각합니다. aws에서 운영되는 서비스인만큼 aws에서 제공하는 `secret manager`나 `parameter store`, `aws kms`등에 지정하고 iam을 통해서 제어하는게 좋을 것 같습니다.  
또한, aws-cli나 fargate-cli등 aws에서 필요한 인증정보를 `vault`를 통해 안전하게 구현할 수 있습니다. 

* Secrets Manager는 어떤 서비스일까요? AWS 외에 비슷한 역할을 하는 서비스로는 어떤 것이 있을까요?
대부분의 애플리케이션은 외부에서 절대로 노출돼서는 안되는 비밀 값들을 가지고 있습니다. 예를 들어 데이터베이스 접속 정보나 서드파티 서비스를 이용하기 위한 비밀 엑세스 키등이 있습니다. 즉, 비밀값의 유출은 서비스에 막대한
영향을 끼칠 수 있는 값들을 애기합니다. `Secret Manager`는 앞서 말한 비밀값들을 관리해주는 서비스입니다. 비밀 값들을 저장해두고 애플리케이션에서 AWS의 API를 호출해서 받아가 사용하는 방식입니다.  
<동작과정>  
1. 관리자가 `Secret Manager`에 비밀을 만들고 그 비밀안에 여러 Key, value 비밀 값들을 등록한다.  
2. 비밀 값들을 AWS KMS라는 키 관리 서비스를 통해 암호화 된다.  
3. 비밀 값들을 사용하는 서버에서 AWS CLI나 SDK를 이용해 특정 IAM 사용자로 Secret Manager에 비밀 값을 요청한다.  
4. IAM에서 요청한 사용자에게 해당 비밀을 조회할 수 있는 권한이 있다면 Secret Manager가 비밀의 값을 복호화해서 응답으로 준다.  
5. 이제 애플리케이션은 받은 비밀값을 사용할 수 있다.  
이외에도, AWS말고 사용할 수 있는 오픈소스가 있습니다. 대표적으로 `Blackbox`와 `vault`입니다. blackbox는 GPG를 이용해 암호화 한 뒤 관리자 관리 등의 작업을 쉽게 이용할 수 있게 만든 쉘 스크립트의 모음입니다.  
Vault는 비밀을 관리하는데 필요한 거의 모든 기능을 제공합니다. 암호화, api접근하는 임시 토큰, 키 롤링, 외부 서비스 권한 시스템 사용(aws iam), 기록감사 등등.. `HTTP API`를 이용해 Vault에게 인증요청을 하고 토큰 기반으로 동작합니다.  

* 어플리케이션 레벨에서의 보안 전략에는 어떤 것들이 있을까요?
AWS을 기준으로 먼저 논리적으로 구축된 네트워크 공간(`VPC`)에서 애플리케이션을 배포합니다. 격리된 네트워크 환경에서 `NACL`이나 올바른 라우팅을 설정한 뒤 프라이빗 서브넷과 NAT를 활용해 좀 더 프라이빗한 환경을 제공합니다. 보안그룹 정책을 애플리케이션과 연동시키고 
민감한 데이터는 비밀값들을 관리해주는 서비스를 구축합니다. (`Secret Manager`) 애플리케이션은 필수로 HTTPS을 지원하게 `Route53`이나 로드벨런서단에서 인증서를 적용합니다. 또한, Route53을 구축하면서 해당 도메인의 `DDOS`공격을 차단하는 서비스를 이용합니다. (AWS Shield)
이제 애플리케이션이 MSA환경이라 가정하고 보안적인 요소를 고려해보겠습니다. 컨테이너 환경의 취약점은 OS입니다. 호스트 OS를 선택할 때 각 호스트에서는 엑세스 제어를 적용해야 되고, 지속적인 모니터링을 통해 취약점을 방어해야 하고 컨테이너 이미지를 프로덕션에 올리기 전에 컨테이너 이미지 스캔을 통해 빌드 단계에서 승인된 이미지만 호환되도록 적용합니다. `Adminstration` 권한은 최소화로 하고 IAM를 활용해 엑세스 권한관리를 합니다. 

## Quest
* VPC를 구축하고, 적절한 서브넷 설정, 보안 그룹과 방화벽을 설정해 보세요. 각각의 단계와 구성요소들이 어떤 의미인지 이해해야 합니다.
* 지금까지 구현한 웹 어플리케이션을 VPC 안에서 서비스 해 보세요.
